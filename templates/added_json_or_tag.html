<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Added JSON</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="sidebar">
        <a class="active" href="{{ url_for('index') }}">Home</a>
        <a href = "{{ url_for('select_by_category') }}">Category</a>
        <a href="{{ url_for('select_by_date') }}">Date</a>
        <a href="{{ url_for('expense_json_loader') }}">JSON loader</a>
    </div>

<div class="content">
    <h1>Last set of entries added from the JSON file.</h1>
    <button  id="submitButton" form="tagForm" type="submit" >Add Tag(s)</button>
    <div class="add_json_tag">
    {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class=flashes>
                {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
    {% endwith %}
    </div>

    <table>
        <thead>
            <tr>
                <th>Expenses ID</th>
                <th>Transaction Date</th>
                <th>Description</th>
                <th>Price</th>
                <th>Tag</th>
            </tr>
            {% for item in result %}
            <tr>
                <td>{{ item.expense_id }}</td>
                <td>{{ item.transaction_date }}</td>
                <td>{{ item.description }}</td>
                <td>{{ item.price }}</td>
                <td>
                <form id="tagForm" class="tagForm" action="{{ url_for('update_after_json_load') }}" method="POST">
                    <input type="hidden" name="expense_id" value="{{ item.expense_id }}">
                    <input type="text" name="tag" aria-hidden="true" maxlength="25">
                </form>
                </td>
            </tr>
            {% endfor %}
        </thead>
    </table>
</div>
<script>
document.getElementById('submitButton').addEventListener('click', function() {
            // Get the main form
            var mainForm = document.getElementById('mainForm');

            // Clear the main form to avoid duplications
            mainForm.innerHTML = '';

            // Get all rows of the table
            var rows = document.querySelectorAll('tbody tr');

            rows.forEach(function(row) {
                var expenseId = row.querySelector('input[name="expense_id"]').value;
                var tag = row.querySelector('input[name="tag"]').value;

                if (tag) { // Only add inputs if a tag is present
                    // Create and append hidden expense ID input
                    var expenseIdInput = document.createElement('input');
                    expenseIdInput.type = 'hidden';
                    expenseIdInput.name = 'expense_id';
                    expenseIdInput.value = expenseId;
                    mainForm.appendChild(expenseIdInput);

                    // Create and append hidden tag input
                    var tagInput = document.createElement('input');
                    tagInput.type = 'hidden';
                    tagInput.name = 'tag';
                    tagInput.value = tag;
                    mainForm.appendChild(tagInput);
                }
            });

            // Submit the form
            mainForm.submit();
        });

</script>
</body>
</html>